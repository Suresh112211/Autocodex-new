// Load Supabase JS SDK via CDN
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';

// Supabase Client Initialize
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 🔐 SIGNUP Function
window.signUp = async function () {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { error } = await supabase.auth.signUp({ email, password });

  if (error) {
    alert("❌ Signup failed: " + error.message);
  } else {
    alert("✅ Signup success! Please log in.");
  }
};

// 🔐 LOGIN Function
window.login = async function () {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) {
    alert("❌ Login failed: " + error.message);
  } else {
    document.getElementById("auth").style.display = "none";
    document.getElementById("project-section").style.display = "block";
    alert("✅ Logged in!");
  }
};

// 💾 SAVE Project
window.save = async function () {
  const session = await supabase.auth.getSession();
  const userId = session.data.session.user.id;

  const title = document.getElementById("title").value;
  const code = document.getElementById("bundle").value;

  const { error } = await supabase.from("projects").insert([
    {
      user_id: userId,
      title: title,
      code_bundle_json: code
    }
  ]);

  if (error) {
    alert("❌ Save failed: " + error.message);
  } else {
    alert("✅ Project saved!");
  }
};

// 📂 LOAD Projects
window.load = async function () {
  const session = await supabase.auth.getSession();
  const userId = session.data.session.user.id;

  const { data, error } = await supabase.from("projects").select("*").eq("user_id", userId);

  if (error) {
    alert("❌ Load failed: " + error.message);
  } else {
    document.getElementById("output").textContent = JSON.stringify(data, null, 2);
  }
};
